<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crypto Tools</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Crypto Tools">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">
  <style>
    :root { --bg:#0b0b0c; --card:#141416; --fg:#f3f4f6; --muted:#9ca3af; --brand:#0b79d0; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--fg); }
    nav { display: flex; position: sticky; top: 0; background: #111; border-bottom: 1px solid #222; z-index: 5; }
    nav button { flex: 1; padding: 12px; background: transparent; color: var(--fg); border: none; font-weight: 600; }
    nav button.active { background: #1b1c1f; }
    .tab { display: none; padding: 16px; }
    .tab.active { display: block; }
    .card { background: var(--card); border-radius: 18px; box-shadow: 0 8px 30px rgba(0,0,0,.25); padding: 16px; }
    label { display:block; font-size: 13px; color: var(--muted); margin-top: 8px; }
    input, select { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #2a2c30; background: #0f1012; color: var(--fg); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn { background: var(--brand); color: #fff; padding: 12px; border: none; border-radius: 12px; font-weight: 700; width: 100%; margin-top: 12px; }
    .result { margin-top: 12px; font-weight: 700; line-height: 1.5; }
    .kv { display:flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #2a2c30; }
  </style>
</head>
<body>
  <nav>
    <button id="btnMargin" class="active">Margin Calc</button>
    <button id="btnSR">S/R Zones</button>
  </nav>

  <!-- Simple Margin Calculator (inputs first, outputs after Calculate) -->
  <div id="marginTab" class="tab active">
    <div class="card">
      <h2 style="margin:0 0 8px">Margin Calculator</h2>

      <!-- Inputs -->
      <div class="row">
        <div>
          <label>Account Size (USD)</label>
          <input id="accountSize" type="number" placeholder="e.g., 100" inputmode="decimal">
        </div>
        <div>
          <label>Risk %</label>
          <input id="riskPercent" type="number" placeholder="e.g., 5" inputmode="decimal">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Entry Price (USD)</label>
          <input id="entryPrice" type="number" placeholder="e.g., 118100" inputmode="decimal">
        </div>
        <div>
          <label>Distance $</label>
          <input id="distance" type="number" placeholder="e.g., 1300" inputmode="decimal">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Leverage (×)</label>
          <input id="leverage" type="number" value="5" min="1" step="1" inputmode="numeric">
        </div>
        <div>
          <label>Risk/Reward Ratio</label>
          <input id="rr" type="number" placeholder="e.g., 2" inputmode="decimal">
        </div>
      </div>

      <button class="btn" id="btnCalc">Calculate</button>

      <!-- Outputs (only after Calculate) -->
      <div id="outputs" class="result" style="display:none">
        <div class="kv"><span>Potential Loss</span><span id="outLoss">$0.00</span></div>
        <div class="kv"><span>Position Size</span><span id="outPos">$0.00</span></div>
        <div class="kv"><span>Stop Loss</span><span id="outSL">$0.00</span></div>
        <div class="kv"><span>Take Profit</span><span id="outTP">$0.00</span></div>
      </div>
    </div>
  </div>

  <!-- Support / Resistance Zones (unchanged) -->
  <div id="srTab" class="tab">
    <div class="card">
      <h2 style="margin:0 0 8px">BTC Support & Resistance</h2>
      <p style="color:#9ca3af; margin:0 0 12px">Zones from clustered swing highs/lows. Default symbol BTCUSDT.</p>

      <div class="row">
        <div>
          <label>Symbol</label>
          <input id="symbol" value="BTCUSDT" placeholder="e.g., BTCUSDT">
        </div>
        <div>
          <label>Candle Timeframe</label>
          <select id="timeframe">
            <option value="1m">1m</option>
            <option value="3m">3m</option>
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option>
            <option value="30m">30m</option>
            <option value="1h">1h</option>
            <option value="2h">2h</option>
            <option value="4h">4h</option>
            <option value="6h">6h</option>
            <option value="8h">8h</option>
            <option value="12h">12h</option>
            <option value="1d">1d</option>
            <option value="3d">3d</option>
            <option value="1w">1w</option>
            <option value="1M">1M (monthly)</option>
            <option value="1Y">1Y (yearly view)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Lookback Window</label>
          <select id="lookback">
            <option value="auto" selected>Auto (max 1000 candles)</option>
            <option value="1w">Last 1 week</option>
            <option value="1m">Last 1 month</option>
            <option value="3m">Last 3 months</option>
            <option value="6m">Last 6 months</option>
            <option value="1y">Last 1 year</option>
          </select>
        </div>
        <div>
          <label>Zone Sensitivity</label>
          <select id="sensitivity">
            <option value="0.5" selected>Normal (≈0.5×ATR)</option>
            <option value="0.3">Tighter (≈0.3×ATR)</option>
            <option value="0.8">Wider (≈0.8×ATR)</option>
          </select>
        </div>
      </div>

      <button class="btn" id="btnZones">Get Zones</button>
      <div id="srResult" class="result"></div>
    </div>
  </div>

<script>
  // Tabs
  const tabs = { margin: document.getElementById('marginTab'), sr: document.getElementById('srTab') };
  document.getElementById('btnMargin').onclick = () => switchTab('margin');
  document.getElementById('btnSR').onclick = () => switchTab('sr');
  function switchTab(tab) {
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    if (tab === 'margin') { document.getElementById('btnMargin').classList.add('active'); tabs.margin.classList.add('active'); }
    if (tab === 'sr') { document.getElementById('btnSR').classList.add('active'); tabs.sr.classList.add('active'); }
  }

  // Utils
  const $ = id => document.getElementById(id);
  const fmt = (n, d=2) => Number(n).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d});

  // Calculator (exact spec)
  document.getElementById('btnCalc').addEventListener('click', ()=>{
    const acct = parseFloat($('accountSize').value);
    const riskPct = parseFloat($('riskPercent').value);
    const entry = parseFloat($('entryPrice').value);
    const dist = parseFloat($('distance').value);
    const lev = Math.max(1, parseInt($('leverage').value)||1);
    const rr = parseFloat($('rr').value);

    if ([acct,riskPct,entry,dist,lev,rr].some(x=>isNaN(x))) { alert('Fill all inputs.'); return; }
    if (acct<=0 || riskPct<=0 || entry<=0 || dist<=0 || lev<=0 || rr<=0) { alert('All values must be positive.'); return; }

    const potentialLoss = acct * (riskPct/100);                  // 3
    const positionSize = (potentialLoss * entry) / (dist * lev); // 7
    const stopLoss = entry - dist;                                // 8 (LONG only)
    const takeProfit = entry + (dist * rr);                       // 10

    $('outLoss').textContent = `$${fmt(potentialLoss,2)}`;
    $('outPos').textContent  = `$${fmt(positionSize,2)}`;
    $('outSL').textContent   = `$${fmt(stopLoss,2)}`;
    $('outTP').textContent   = `$${fmt(takeProfit,2)}`;

    $('outputs').style.display = '';
  });

  // --- S/R (same as before, with Binance fallbacks) ---
  async function fetchKlines(symbol, interval, limit=1000) {
    const endpoints = [
      `https://data-api.binance.vision/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`,
      `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`,
      `https://api.binance.us/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`
    ];
    let lastErr;
    for (const url of endpoints) {
      try { const res = await fetch(url, { cache: 'no-store', mode: 'cors' }); if (res.ok) return await res.json(); lastErr = new Error(`HTTP ${res.status}`);} catch(e){ lastErr=e; }
    }
    throw lastErr || new Error('All endpoints failed');
  }
  function computeATR(klines, period=14){
    const highs=klines.map(c=>+c[2]); const lows=klines.map(c=>+c[3]); const closes=klines.map(c=>+c[4]);
    const TR=[]; for(let i=0;i<highs.length;i++){ if(i===0){TR.push(highs[i]-lows[i]); continue;} const pc=closes[i-1]; TR.push(Math.max(highs[i]-lows[i], Math.abs(highs[i]-pc), Math.abs(lows[i]-pc))); }
    const n=Math.min(period,TR.length); return TR.slice(-n).reduce((a,b)=>a+b,0)/n;
  }
  function findSwingPoints(klines, window=3){ const H=klines.map(c=>+c[2]); const L=klines.map(c=>+c[3]); const hi=[],lo=[]; for(let i=window;i<klines.length-window;i++){ const h=H[i], l=L[i]; let isMax=true,isMin=true; for(let j=i-window;j<=i+window;j++){ if(H[j]>h) isMax=false; if(L[j]<l) isMin=false; } if(isMax) hi.push(h); if(isMin) lo.push(l);} return {swingsHi:hi,swingsLo:lo}; }
  function clusterLevels(levels,tol){ levels.sort((a,b)=>a-b); const clusters=[]; let cur=[]; for(const lv of levels){ if(!cur.length||Math.abs(lv-cur[cur.length-1])<=tol){cur.push(lv);} else {clusters.push(cur.slice()); cur=[lv];}} if(cur.length) clusters.push(cur); return clusters.map(arr=>({min:Math.min(...arr),max:Math.max(...arr),count:arr.length,mid:(Math.min(...arr)+Math.max(...arr))/2})); }
  function msForWindow(val){ const d=86400000; if(val==='1w') return 7*d; if(val==='1m') return 30*d; if(val==='3m') return 90*d; if(val==='6m') return 180*d; if(val==='1y') return 365*d; return null; }
  async function computeZones(){ const sym=($('symbol').value||'BTCUSDT').toUpperCase(); const tfSel=$('timeframe').value; const lookback=$('lookback').value; const fetchTF=(tfSel==='1Y')?'1M':tfSel; const kl=await fetchKlines(sym,fetchTF,1000); let data=kl; if(tfSel==='1Y'){ data=kl.slice(-12);} else if(lookback!=='auto'){ const cutoff=kl[kl.length-1][0]-msForWindow(lookback); data=kl.filter(c=>c[0]>=cutoff); if(data.length<50) data=kl.slice(-Math.min(200,kl.length)); } const atr=computeATR(data,14); const {swingsHi,swingsLo}=findSwingPoints(data,3); const tol=Math.max(atr*0.5,5); const res=clusterLevels(swingsHi,tol).sort((a,b)=>b.mid-a.mid); const sup=clusterLevels(swingsLo,tol).sort((a,b)=>a.mid-b.mid); const close=+data[data.length-1][4]; return {res,sup,atr,close,sym,tfSel}; }
  document.getElementById('btnZones').addEventListener('click', async()=>{ try{ $('srResult').textContent='Calculating…'; const {res,sup,atr,close,sym,tfSel}=await computeZones(); const fmtn=(n)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:2,minimumFractionDigits:2}); const row=(z,l)=>z.slice(0,4).map(x=>`<div class=\"kv\"><span>${l} (${x.count})</span><span>$${fmtn(x.min)} – $${fmtn(x.max)}</span></div>`).join(''); $('srResult').innerHTML = `<div class=\"kv\"><span>Symbol / TF</span><span>${sym} • ${tfSel}</span></div><div class=\"kv\"><span>Last Close</span><span>$${fmtn(close)}</span></div><div class=\"kv\"><span>ATR(14)</span><span>$${fmtn(atr)}</span></div><hr style=\"border:none;border-top:1px solid #2a2c30;margin:8px 0\">${row(sup,'Support')}${row(res,'Resistance')}`; } catch(err){ $('srResult').textContent='Error: '+err.message; }});

  // PWA
  if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js'); }); }
</script>
</body>
</html>
